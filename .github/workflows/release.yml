# Copyright 2023 DSR Corporation, Denver, Colorado.
# https://www.dsr-corporation.com
# SPDX-License-Identifier: Apache-2.0

name: Release

on:
  push:
    branches: [fix-release-workflow]

permissions:
  contents: write


jobs:

  checks:
    name: Check version & existing release
    # if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    outputs:
      current_version: ${{ steps.current_version.outputs.current_version }}
      existing_release_info: ${{ steps.check_existing_release.outputs.release_info }}
      asset_crate_url: ${{ steps.check_existing_release.outputs.asset_crate_url }}
      upload_url:  ${{ steps.check_existing_release.outputs.upload_url }}
      already_in_crates_io: ${{ steps.check_in_crates_io.outputs.already_in_crates_io != '' }}
    defaults:
      run:
        working-directory: cli

    steps:
      - uses: actions/checkout@v3

      - name: Get current version
        id: current_version
        run: |
          version="$(cargo -q metadata --no-deps \
            | jq -r '.packages[] | select(.name == "indy-cli-rs") | .version')"
          echo "$version"
          echo "::set-output name=current_version::$version"
        shell: bash

      - name: Check existing release
        id: check_existing_release
        run: |
          release_info="$(curl -s https://api.github.com/repos/${{ github.repository }}/releases \
              | jq '.[] | select(.name == "v${{ steps.current_version.outputs.current_version }}")')"
          echo "::set-output name=release_info::$release_info"
          echo "$release_info"

          asset_crate_url="$(echo "$release_info" \
              | jq -r '.assets[] | select(.name | match("^indy-cli-rs.*\\.crate$")) | .browser_download_url')"
          echo "::set-output name=asset_crate_url::$asset_crate_url"
          echo "$asset_crate_url"

          upload_url="$(echo "$release_info" | jq -r '.upload_url')"
          echo "::set-output name=upload_url::$upload_url"
          echo "$upload_url"
        shell: bash

      - name: Check if already deployed to crates.io
        id: check_in_crates_io
        run: |
          out="$(curl -s https://crates.io/api/v1/crates/indy-cli-rs | jq -r '.versions[] | .num' \
            | grep '^${{ steps.current_version.outputs.current_version }}$')"
          echo "in crates.io check: $out"
          echo "::set-output name=already_in_crates_io::$out"
        shell: bash {0}  # to opt-out of default fail-fast behavior

  create_release:
    name: Create release
    # if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    needs: checks
    outputs:
      upload_url: ${{ steps.upload_url.outputs.value }}

    steps:
      - uses: actions/checkout@v3

      - name: Create GitHub Release
        id: create_release
        if: ${{ !needs.checks.outputs.existing_release_info }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.checks.outputs.current_version }}
          release_name: v${{ needs.checks.outputs.current_version }}

      - name: Set upload url
        id: upload_url
        if: ${{ !needs.checks.outputs.asset_crate_url }}
        run: |
          if [[ -n "${{ needs.checks.outputs.upload_url }}" ]]; then
            echo "::set-output name=value::${{ needs.checks.outputs.upload_url }}"
          else
            echo "::set-output name=value::${{ steps.create_release.outputs.upload_url }}"
          fi

  publish_crate:
    name: Publish crate
    # Enable this when all dependencies are published
    if: ${{ false }} #github.ref == 'refs/heads/main' && ${{ !needs.checks.outputs.asset_crate_url }}
    runs-on: ubuntu-latest
    needs: [ checks, create_release ]
    defaults:
      run:
        working-directory: cli

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Package and verify crate
        id: build_crate
        run: |
          cargo package
          
          # TODO
          #   - verify that it's not more than crates.io limit (10 MB)
          #   - explore whether we need to upload another artifact (without extension)
          ls -la target/package
          cargo package --list
          
          asset_name="$(find target/package -name '*.crate' -printf '%f')"
          echo "::set-output name=asset_name::$asset_name"
        shell: bash

      - name: Upload crate to GitHub
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.checks.outputs.upload_url }}
          asset_path: target/package/${{ steps.build_crate.outputs.asset_name }}
          asset_name: ${{ steps.build_crate.outputs.asset_name }}
          asset_content_type: application/octet-stream  # TODO check for less generic type

#        - name: Publish to crates.io
#          if: needs.checks.outputs.already_in_crates_io == 'false'
#          env:
#            CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
#          run: cargo publish
#          shell: bash


  publish_assets:
    name: Publish assets
    #if: github.ref == 'refs/heads/main'
    needs: [ checks, create_release ]
    strategy:
      matrix:
        include:
          - arch: linux-x86_64
            os: ubuntu-latest
            executable:
            target: x86_64-unknown-linux-gnu
            # using cross here to build against an older glibc for compatibility
            use_cross: true
          - arch: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
          - arch: darwin-x86_64
            os: macos-11
            target: x86_64-apple-darwin
          - arch: darwin-aarch64
            os: macos-11
            target: aarch64-apple-darwin
            # beta or nightly required for aarch64-apple-darwin target
            toolchain: beta
    defaults:
      run:
        working-directory: cli

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v3

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ matrix.toolchain || 'stable' }}
          targets: ${{ matrix.target }}

      - name: Cache cargo resources
        uses: Swatinem/rust-cache@v2

      - name: Build
        if: ${{ !matrix.useCross }}
        run: cargo build --target ${{ matrix.target }} --locked --release

      - name: Build (cross)
        if: ${{ matrix.useCross }}
        run: |
          cargo install --bins --git https://github.com/rust-embedded/cross --tag v0.2.4 cross
          cargo build --target ${{ matrix.target }} --locked --release

      - name: Create release assets directory
        run: |
          mkdir release-assets
          cp -r target/${{ matrix.target }}/release/ release-assets/

      - name: Pack asset
        uses: a7ul/tar-action@v1.1.2
        with:
          command: c
          cwd: cli/release-assets
          files: .
          outPath: "indy-cli-rs.tar.gz"

      - name: Upload asset to GitHub
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ needs.create_release.outputs.upload_url }}
          asset_path: cli/release-assets/indy-cli-rs.tar.gz
          asset_name: indy-cli-rs-${{ needs.checks.outputs.current_version }}-${{ matrix.arch }}.tar.gz
          asset_content_type: application/x-gtar
